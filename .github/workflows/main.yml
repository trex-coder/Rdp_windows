name: CI

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Install Chrome and Chrome Remote Desktop
      run: |
        brew install --cask google-chrome
        brew install --cask chrome-remote-desktop-host
        # Use launchctl bootstrap for proper activation
        sudo launchctl bootstrap system /Library/LaunchAgents/com.google.chrome.remote-desktop.plist || echo "Failed to bootstrap service."

    - name: Locate start-host Script
      run: |
        START_HOST_PATH=$(find / -name start-host 2>/dev/null | head -n 1)
        if [ -z "$START_HOST_PATH" ]; then
          echo "start-host script not found."
          exit 1
        else
          echo "start-host script located at: $START_HOST_PATH"
        fi
        echo "START_HOST_PATH=$START_HOST_PATH" >> $GITHUB_ENV

    - name: Download and Extract ngrok
      run: |
        curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-darwin-amd64.zip -o ngrok.zip
        unzip ngrok.zip

    - name: Authenticate ngrok
      run: ./ngrok authtoken $NGROK_AUTH_TOKEN
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Create runneradmin User
      run: sudo sysadminctl -addUser runneradmin -password P@ssw0rd! -admin

    - name: Start Chrome Remote Desktop
      run: |
        export DISPLAY=
        $START_HOST_PATH \
          --code="4/0AeanS0YlZGEWmEyWPbxRAph-fTyumhtTCvYAK0_YK2bi6kjsltyhjJTefS32jjJuRZGezA" \
          --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
          --name=$(hostname)

    - name: Enable Screen Sharing and Remote Login
      run: |
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -privs -all -users runneradmin
        sudo systemsetup -setremotelogin on

    - name: Set Password
      run: sudo sysadminctl -adminUser admin -adminPassword adminpassword -resetPasswordFor runneradmin -newPassword P@ssw0rd!

    - name: Start ngrok Tunnel
      run: ./ngrok tcp 5900
